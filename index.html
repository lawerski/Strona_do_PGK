<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Let's Quiz - Do≈ÇƒÖcz</title>
    <style>
        /* --- STYLIZACJA (CSS) --- */
        :root {
            --bg-color: #1a1a2e;
            --accent-color: #e94560;
            --secondary-color: #16213e;
            --text-color: #ffffff;
            --highlight: #0f3460;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            margin: 0; padding: 0;
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            min-height: 100vh; overflow: hidden;
            touch-action: none; /* Zapobiega przewijaniu przy rysowaniu */
        }

        .screen {
            width: 90%; max-width: 400px;
            display: none; flex-direction: column;
            align-items: center; text-align: center;
            animation: fadeIn 0.3s ease-in-out;
        }
        .screen.active { display: flex; }

        h1 { margin-bottom: 10px; color: var(--accent-color); text-transform: uppercase; letter-spacing: 2px; }
        
        input[type="text"] {
            width: 100%; padding: 15px; margin-bottom: 10px;
            border: 2px solid var(--highlight); border-radius: 8px;
            background-color: var(--secondary-color); color: white;
            font-size: 1.1rem; text-align: center; box-sizing: border-box;
            outline: none;
        }
        input[type="text"]:focus { border-color: var(--accent-color); }

        .btn {
            width: 100%; padding: 15px; margin-top: 10px;
            border: none; border-radius: 8px;
            background-color: var(--accent-color); color: white;
            font-size: 1.2rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 0 #9e2a3b;
            transition: transform 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }

        /* --- CANVAS I NARZƒòDZIA --- */
        .canvas-wrapper {
            background-color: white;
            border-radius: 10px; padding: 5px; margin-bottom: 10px;
            box-shadow: 0 0 15px rgba(233, 69, 96, 0.3);
            cursor: crosshair; position: relative;
        }

        canvas { display: block; touch-action: none; }

        .tools {
            display: flex; gap: 8px; margin-bottom: 15px;
            justify-content: center; flex-wrap: wrap; width: 100%;
        }

        .color-swatch {
            width: 30px; height: 30px; border-radius: 50%;
            border: 2px solid #fff; cursor: pointer;
        }
        .color-swatch.active { transform: scale(1.2); border-color: var(--accent-color); }
        
        .btn-tool {
            padding: 8px 12px; font-size: 0.85rem;
            background-color: var(--secondary-color);
            border: 1px solid white; border-radius: 5px; color: white;
            cursor: pointer;
        }

        /* Ukryty input do plik√≥w */
        #file-upload { display: none; }

        #lobby-avatar-img {
            width: 150px; height: 150px; border-radius: 10px;
            background-color: white; border: 4px solid var(--accent-color);
            margin-bottom: 20px; object-fit: contain;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #status-bar { position: fixed; bottom: 10px; font-size: 0.8rem; opacity: 0.6; }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <h1>Tw√≥j Avatar</h1>
        
        <div class="canvas-wrapper">
            <canvas id="drawing-canvas" width="250" height="250"></canvas>
        </div>

        <div class="tools">
            <div class="color-swatch active" style="background: black;" onclick="setColor('black', this)"></div>
            <div class="color-swatch" style="background: #e94560;" onclick="setColor('#e94560', this)"></div>
            <div class="color-swatch" style="background: #00b894;" onclick="setColor('#00b894', this)"></div>
            <div class="color-swatch" style="background: #0984e3;" onclick="setColor('#0984e3', this)"></div>
            
            <button class="btn-tool" onclick="clearCanvas()">üóëÔ∏è Wyczy≈õƒá</button>
            <button class="btn-tool" onclick="document.getElementById('file-upload').click()">üì∑ Zdjƒôcie</button>
        </div>

        <input type="file" id="file-upload" accept="image/*">

        <input type="text" id="input-nick" placeholder="Tw√≥j Pseudonim" maxlength="12">
        <input type="text" id="input-room" placeholder="Kod Pokoju (np. ABCD)" maxlength="4" style="text-transform: uppercase;">

        <button class="btn" onclick="joinGame()">DO≈ÅƒÑCZ DO GRY</button>
    </div>

    <div id="screen-lobby" class="screen">
        <h2>Czekamy na start...</h2>
        <img id="lobby-avatar-img" src="" alt="Tw√≥j avatar">
        <h1 id="lobby-nick">Gracz</h1>
        <div class="loader">Patrz na du≈ºy ekran!</div>
    </div>

    <div id="screen-game-input" class="screen">
        <h2 id="question-text">Wpisz odpowied≈∫:</h2>
        <input type="text" id="game-answer-input" placeholder="..." autocomplete="off">
        <button class="btn" onclick="sendAnswer()">WY≈öLIJ</button>
    </div>

    <div id="status-bar">Niepo≈ÇƒÖczony</div>

    <script>
        // --- KONFIGURACJA ---
        const SERVER_URL = "ws://188.68.247.91:8910"; // Tw√≥j sta≈Çy adres IP

        /* --- LOGIKA CANVAS (RYSOWANIE + ZDJƒòCIA) --- */
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const fileInput = document.getElementById('file-upload');
        let painting = false;
        
        // Setup poczƒÖtkowy
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.lineWidth = 5;
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'black';

        // --- OBS≈ÅUGA ZDJƒòCIA Z GALERII ---
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const scale = Math.max(canvas.width / img.width, canvas.height / img.height);
                    const x = (canvas.width / 2) - (img.width / 2) * scale;
                    const y = (canvas.height / 2) - (img.height / 2) * scale;
                    
                    ctx.clearRect(0,0, canvas.width, canvas.height);
                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        // --- OBS≈ÅUGA RYSOWANIA ---
        function startPosition(e) { painting = true; draw(e); }
        function endPosition() { painting = false; ctx.beginPath(); }
        
        function draw(e) {
            if (!painting) return;
            // e.preventDefault(); // Usuniƒôte, bo w body jest touch-action: none
            
            let clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(clientX - rect.left, clientY - rect.top);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(clientX - rect.left, clientY - rect.top);
        }

        canvas.addEventListener('mousedown', startPosition);
        canvas.addEventListener('mouseup', endPosition);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchstart', startPosition, {passive: false});
        canvas.addEventListener('touchend', endPosition);
        canvas.addEventListener('touchmove', draw, {passive: false});

        function setColor(color, element) {
            ctx.strokeStyle = color;
            document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }

        function clearCanvas() {
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        /* --- LOGIKA SIECIOWA --- */
        let socket;
        let playerNick = "";

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function joinGame() {
            const nick = document.getElementById('input-nick').value;
            const room = document.getElementById('input-room').value.toUpperCase();

            if (!nick || !room) { alert("Wpisz nick i kod!"); return; }

            const avatarData = canvas.toDataURL('image/png');
            playerNick = nick;
            document.getElementById('status-bar').innerText = "≈ÅƒÖczenie...";

            try {
                // U≈ºywamy sta≈Çego adresu IP
                socket = new WebSocket(SERVER_URL);
            } catch(e) {
                alert("B≈ÇƒÖd inicjalizacji WebSocket.");
                return;
            }

            socket.onopen = () => {
                document.getElementById('status-bar').innerText = "Po≈ÇƒÖczono!";
                
                // POPRAWIONA STRUKTURA dla twojego server.js
                socket.send(JSON.stringify({
                    type: "join_request",
                    room: room,       // To musi byƒá w g≈Ç√≥wnym obiekcie
                    nick: playerNick, // Opcjonalne dodatki
                    avatar: avatarData
                }));
            };
            
            socket.onerror = (error) => {
                console.error("B≈ÇƒÖd WebSocket:", error);
                document.getElementById('status-bar').innerText = "B≈ÇƒÖd po≈ÇƒÖczenia z serwerem.";
            };

            socket.onmessage = (event) => handleServerMessage(JSON.parse(event.data));
            
            // Obs≈Çuga zamkniƒôcia przez serwer (np. b≈Çƒôdny pok√≥j)
            socket.onclose = () => {
                document.getElementById('status-bar').innerText = "Roz≈ÇƒÖczono.";
            };
        }

        function handleServerMessage(msg) {
            if (msg.type === "error") {
                alert(msg.message); // np. "Pok√≥j nie istnieje"
                socket.close();
                return;
            }

            if(msg.type === "join_success") {
                document.getElementById('lobby-avatar-img').src = canvas.toDataURL();
                document.getElementById('lobby-nick').innerText = playerNick;
                showScreen('screen-lobby');
            }
            
            if(msg.type === "game_start_text") {
                showScreen('screen-game-input');
            }
        }

        function sendAnswer() {
            const answer = document.getElementById('game-answer-input').value;
            if(answer && socket) {
                // Klient wysy≈Ça dane, kt√≥re serwer opakuje w "client_msg" dla hosta
                socket.send(JSON.stringify({
                    type: "player_answer", 
                    answer: answer
                }));
                document.getElementById('game-answer-input').value = ""; 
            }
        }
    </script>
</body>
</html>
